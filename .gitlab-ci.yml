# Ada-loom-registry (Spindle) - Comprehensive GitLab CI/CD Pipeline
# Haskell Nickel parser and registry manager

variables:
  GHC_VERSION: "9.4.8"
  CABAL_VERSION: "3.10"
  NICKEL_VERSION: "1.4.0"
  SAST_EXCLUDED_PATHS: "dist-newstyle, .stack-work"

stages:
  - preflight
  - build
  - test
  - quality
  - security
  - integration
  - docs
  - deploy

# ==================== Templates ====================

.haskell-base:
  image: haskell:${GHC_VERSION}
  cache:
    key: haskell-spindle-$CI_COMMIT_REF_SLUG
    paths:
      - dist-newstyle/
      - ~/.cabal/
      - ~/.ghc/
  before_script:
    - ghc --version
    - cabal --version

# ==================== Preflight ====================

preflight:info:
  extends: .haskell-base
  stage: preflight
  script:
    - echo "Spindle (Ada-loom-registry) CI/CD Pipeline"
    - echo "Haskell Nickel parser"
    - echo "GHC: $(ghc --version)"
    - echo "Cabal: $(cabal --version)"
    - |
      if [ -f ".tool-versions" ]; then
        echo "ASDF versions:"
        cat .tool-versions
      fi

validate:cabal-file:
  extends: .haskell-base
  stage: preflight
  script:
    - cabal check
    - cabal outdated --freeze-file || echo "No outdated check"

# ==================== Build ====================

build:cabal:
  extends: .haskell-base
  stage: build
  script:
    - cabal update
    - cabal build --enable-tests --enable-benchmarks all
  artifacts:
    paths:
      - dist-newstyle/
    expire_in: 1 day

build:documentation:
  extends: .haskell-base
  stage: build
  dependencies:
    - build:cabal
  script:
    - cabal haddock --enable-documentation all
  artifacts:
    paths:
      - dist-newstyle/doc/
    expire_in: 30 days

# ==================== Test ====================

test:unit:
  extends: .haskell-base
  stage: test
  dependencies:
    - build:cabal
  script:
    - cabal test --enable-coverage --test-show-details=direct all
  coverage: '/^\s*(\d+)% expressions used/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - dist-newstyle/build/**/hpc/
    when: always
    expire_in: 30 days

test:benchmarks:
  extends: .haskell-base
  stage: test
  dependencies:
    - build:cabal
  script:
    - cabal bench all || echo "Benchmarks not configured"
  artifacts:
    paths:
      - dist-newstyle/benchmark-results/
    expire_in: 30 days
  allow_failure: true

# ==================== Quality ====================

quality:hlint:
  extends: .haskell-base
  stage: quality
  before_script:
    - cabal install hlint
  script:
    - hlint app/ --json > hlint-report.json || true
    - hlint app/
  artifacts:
    paths:
      - hlint-report.json
    when: always
    expire_in: 30 days
  allow_failure: true

quality:stylish-haskell:
  extends: .haskell-base
  stage: quality
  before_script:
    - cabal install stylish-haskell
  script:
    - find app -name "*.hs" -exec stylish-haskell --check {} \;
  allow_failure: true

quality:stan:
  extends: .haskell-base
  stage: quality
  dependencies:
    - build:cabal
  before_script:
    - cabal install stan || echo "Stan installation failed"
  script:
    - |
      if command -v stan &> /dev/null; then
        stan
      fi
  allow_failure: true

# ==================== Security ====================

security:deps-audit:
  extends: .haskell-base
  stage: security
  script:
    - cabal outdated --freeze-file || echo "Outdated check"
    - cabal check

include:
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/License-Scanning.gitlab-ci.yml

# ==================== Integration ====================

integration:nickel-parsing:
  stage: integration
  image: ghcr.io/tweag/nickel:${NICKEL_VERSION}
  dependencies:
    - build:cabal
  before_script:
    - apk add --no-cache haskell
  script:
    - |
      echo "Testing Nickel file parsing with Spindle..."
      # Test parsing various Nickel files
      find . -name "*.ncl" -exec echo "Parsing {}" \;
  allow_failure: true

# ==================== Documentation ====================

docs:haddock:
  extends: .haskell-base
  stage: docs
  dependencies:
    - build:documentation
  script:
    - cabal haddock --haddock-html --haddock-hyperlink-source
  artifacts:
    paths:
      - dist-newstyle/doc/html/
    expire_in: 30 days

docs:readme:
  stage: docs
  image: ruby:3.2-alpine
  before_script:
    - apk add --no-cache asciidoctor
  script:
    - |
      mkdir -p public/docs
      if [ -f "README.adoc" ]; then
        asciidoctor README.adoc -D public/docs
      fi
      if [ -f "README.md" ]; then
        cp README.md public/docs/
      fi
  artifacts:
    paths:
      - public/docs/
    expire_in: 30 days

# ==================== Deploy ====================

deploy:binary:
  extends: .haskell-base
  stage: deploy
  dependencies:
    - build:cabal
  script:
    - cabal install --install-method=copy --installdir=./bin
    - ls -lah bin/
  artifacts:
    paths:
      - bin/
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'

pages:
  stage: deploy
  dependencies:
    - docs:haddock
    - docs:readme
  script:
    - mkdir -p public
    - cp -r dist-newstyle/doc/html/* public/ 2>/dev/null || true
    - cp -r public/docs/* public/ 2>/dev/null || true
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

# ==================== Release ====================

release:hackage:
  extends: .haskell-base
  stage: deploy
  dependencies:
    - build:cabal
    - test:unit
  script:
    - cabal sdist
    - cabal upload --publish || echo "Hackage upload (requires credentials)"
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  when: manual

release:create:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  dependencies:
    - deploy:binary
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}"
  release:
    name: 'Spindle $CI_COMMIT_TAG'
    description: |
      Spindle (Ada-loom-registry) $CI_COMMIT_TAG

      Haskell Nickel parser and registry manager

      ## Features
      - Nickel configuration parsing
      - Registry management
      - Loom integration

      See CHANGELOG.md for full details.
    tag_name: '$CI_COMMIT_TAG'
    assets:
      links:
        - name: 'Binary'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/download?job=deploy:binary'
        - name: 'Haddock Documentation'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/browse?job=docs:haddock'
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
