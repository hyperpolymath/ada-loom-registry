= Cookbook - ada-loom-registry
:toc: macro

[abstract]
--
Practical guide to Just recipes for ada-loom-registry (Haskell + Nickel parser for Ada ecosystem registry). Rhodium Standard 0.5, Pillar 1, Section 2.1.3.
--

toc::[]

== Quick Reference

[source,bash]
----
# Build
just build

# Test
just test

# Registry operations
just registry-publish ENTRY
just registry-query PACKAGE

# Export
just export-registry
----

== Building

=== `just build`

**Purpose:** Build Haskell + Nickel parser integration

**What it does:**
* `cabal build`
* Compiles Nickel parser bindings
* Links Ada ecosystem registry modules

**GHC version:** 9.6.3 (WASM-ready via wasm32-wasi)

**Time estimate:** 5-15 minutes (Nickel parser compilation)

=== `just build-wasm`

**Purpose:** Build for WASM target

**What it does:**
* `cabal build --with-ghc wasm32-wasi-ghc`
* Compiles to WebAssembly

**Advantage:** GHC 9.6.3 supports WASM out-of-the-box

== Testing

=== `just test`

**Purpose:** Run test suite

**What it does:**
* `cabal test`
* Tests Nickel parser integration
* Validates registry operations

=== `just test-nickel`

**Purpose:** Test Nickel schema validation

**What it does:**
* Evaluates test schemas in `test/schemas/`
* Validates against registry contract

== Registry Operations

=== `just registry-publish ENTRY`

**Purpose:** Publish package entry to registry

**Example:**
[source,bash]
----
just registry-publish my-package-1.0.0
----

**What it does:**
1. Validates entry against Nickel schema
2. Adds to registry database
3. Updates index
4. **⚠️ Irreversible** (use soft deletes)

=== `just registry-query PACKAGE`

**Purpose:** Query registry for package information

**Example:**
[source,bash]
----
just registry-query gnatcoll
----

**Output:** Package metadata, versions, dependencies

=== `just registry-publish-staging ENTRY`

**Purpose:** Publish to staging registry (reversible)

**Use:** Test before production publish

=== `just registry-rollback-entry ENTRY_ID`

**Purpose:** Soft-delete entry (mark as deprecated)

=== `just registry-validate`

**Purpose:** Validate entire registry integrity

**What it does:**
* Checks all entries against Nickel schemas
* Validates dependency graph (no cycles)
* Verifies index consistency

== Schema Management

=== `just validate-schema`

**Purpose:** Validate Nickel registry schemas

**What it does:**
* `nickel typecheck schemas/registry.ncl`
* Checks schema consistency

=== `just export-schema`

**Purpose:** Export schemas to JSON for external tools

**Output:** `schemas/registry.json`

== Index Operations

=== `just rebuild-registry-index`

**Purpose:** Rebuild search index from scratch

**When to use:**
* After bulk imports
* Index corruption
* Schema migrations

**Time estimate:** 5-15 minutes (depends on registry size)

=== `just reindex-incremental`

**Purpose:** Incremental index update

**Use:** After single entry publish

== Export and Backup

=== `just export-registry`

**Purpose:** Export entire registry to portable format

**Output:** `registry-export-TIMESTAMP.json`

**Use:** Backups, migrations, archival

=== `just import-registry FILE`

**Purpose:** Import registry from export file

**⚠️ WARNING:** Overwrites existing registry

== Configuration

=== `just apply-config`

**Purpose:** Apply Nickel configuration

**What it does:**
* Evaluates `config/registry.ncl`
* Updates registry settings
* Reconfigures parser

== Nickel Parser

=== `just nickel-eval FILE`

**Purpose:** Evaluate Nickel file

**Example:**
[source,bash]
----
just nickel-eval config/registry.ncl
----

=== `just nickel-export FILE`

**Purpose:** Export Nickel to JSON

=== `just nickel-typecheck FILE`

**Purpose:** Typecheck Nickel file

== Troubleshooting

**"Nickel parser error"**
→ Check syntax: `just nickel-typecheck FILE`

**"Registry entry already exists"**
→ Version bump required (semver)

**"Index out of sync"**
→ Rebuild: `just rebuild-registry-index`

**"Schema validation failed"**
→ Check entry format against `schemas/registry.ncl`

== References

* link:https://nickel-lang.org/[Nickel Language]
* link:https://www.haskell.org/ghc/blog/20230914-wasm-backend-merged.html[GHC WASM Support]
* link:docs/adr/0002-nickel-parser-integration.adoc[ADR-0002: Nickel Parser]
* link:REVERSIBILITY.adoc[Reversibility Procedures]

---

_Last Updated: 2025-01-21 | Rhodium Standard 0.5_
